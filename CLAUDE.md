# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## 重要な指示

このリポジトリで作業する際は、**必ず日本語でレスポンスしてください**。ユーザーとのコミュニケーションは全て日本語で行うことが必要です。

## プロジェクト概要

UniPicは、重複画像の検出と削除を行うElectronベースのデスクトップアプリケーションです。バイナリハッシュ比較（MD5）とパーセプチュアルハッシュ（pHash）比較の両方を使用して、同一画像と視覚的に類似した画像を検出します。

## コマンド

**開発・実行**
- `npm start` - 本番モードでアプリケーションを実行
- `npm run dev` - 開発者ツールを有効にしてアプリケーションを実行  
- VS CodeでF5キー - 設定されたlaunch.jsonを使用してアプリを起動

**ビルド**
- `npm run build` - 現在のプラットフォーム向けにアプリをビルド
- `npm run build-mac` - macOS向けにアプリをビルド（DMG + ZIP）
- `npm run build-win` - Windows向けにアプリをビルド
- `npm run build-linux` - Linux向けにアプリをビルド

## アーキテクチャ

### コア構造

**メインプロセス (`main.js`)**
- ファイルシステム操作と画像処理を担当
- Sharpライブラリを使用した画像操作によるpHashアルゴリズムの実装
- レンダラープロセスとのIPC通信管理
- メインウィンドウと画像ビューアウィンドウの両方を作成
- メモリ効率のためのバッチ処理による画像ハッシュの並列処理

**メインウィンドウ (`index.html` + `renderer.js`)**
- フォルダ選択と重複表示のためのプライマリUI
- ドラッグ&ドロップによるフォルダ選択をサポート
- 類似度閾値スライダー（pHash距離の0-20範囲）を表示
- 「バイナリ同一」と「視覚的類似」を視覚的に区別して重複を表示
- ハッシュ計算と比較フェーズのリアルタイム進捗追跡

**画像ビューアウィンドウ (`image-viewer.html` + `image-viewer.js`)**
- 詳細な画像比較のための最大化されたセカンダリウィンドウ
- キーボードナビゲーション（矢印キー、A/Dキー、Delete、Space、F、Esc）をサポート
- メインウィンドウへの自動同期を伴うファイル削除機能
- 縦向き・横向き画像の両方を適切に処理するアスペクトフィット表示
- 詳細なファイル情報表示（サイズ、作成/更新日時、解像度）

### 主要技術コンポーネント

**重複検出アルゴリズム**
1. **バイナリハッシュ**: 完全重複のためのファイル内容のMD5ハッシュ
2. **パーセプチュアルハッシュ**: Sharpライブラリを使用した視覚的類似性のためのDCTベース63ビットハッシュ
3. **並列処理**: パフォーマンス向上のためのCPU数×2のバッチサイズとPromise.all
4. **ハミング距離**: pHash類似性の比較メトリック（設定可能な閾値）

**IPC通信**
- `select-folder` - フォルダ選択ダイアログ
- `scan-images` - 再帰的な画像ファイル検索
- `find-duplicates` - 進捗イベント付きのメイン重複検出
- `delete-file` / `delete-file-from-viewer` - ファイル削除操作
- `open-image-viewer` - 画像比較ウィンドウの起動
- 進捗イベント: `hash-progress`, `comparison-progress`, `file-deleted`

**画像処理**
- SharpによるWebP、AVIF、HEICを含む全主要フォーマットをサポート
- 未対応フォーマットのためのフォールバックハッシュ生成
- 32×32グレースケールリサイズ → 8×8 DCT → 63ビットハッシュ生成
- グレースフルデグラデーションによるエラーハンドリング

## 開発ノート

**VS Code統合**
- F5は開発者ツールなしでアプリを起動（本番環境類似）
- DevToolsによる開発には`npm run dev`を使用

**画像フォーマットサポート**
- プライマリ: JPEG、PNG、WebP、AVIF、TIFF、BMP、GIF、HEIC
- フォールバック: 未対応フォーマットのファイルメタデータを使用したSHA256ベースハッシュ

**UI状態管理**
- メインウィンドウがスキャン状態と重複結果を管理
- 画像ビューアは独立して動作するが、IPCを通じて削除を同期
- 進捗インジケータはファイルレベルと比較レベルの両方の進捗を表示

**パフォーマンス考慮事項**
- 大量画像コレクションでのメモリオーバーフローを防ぐバッチ処理
- メモリガベージコレクションのためのバッチ間50ms遅延
- 進捗更新の間引き（ハッシュ化では毎ファイル、検出では100回の比較毎）

**アプリアイコン設定**
- アプリアイコンは`icon/icon.png`を使用（512x512ピクセル推奨）
- nativeImage.createFromPath()でPNG形式のアイコンを読み込み
- macOSでは`app.dock.setIcon()`を使用してDockアイコンを設定
- メインウィンドウと画像ビューアウィンドウの両方にアイコンを設定
- ICNSファイルよりもPNGファイルの方が安定して動作

**Sharp依存関係の課題と解決**

Sharp（ネイティブ画像処理ライブラリ）をElectronアプリでビルドする際に遭遇した問題と解決方法：

*主な問題:*
- ビルド済みアプリで「Could not load the "sharp" module using the darwin-arm64 runtime」エラー
- libvips-cpp.42.dylibが見つからないエラー
- Sharpのネイティブバイナリがアプリパッケージに正しく含まれない

*試行した解決方法:*
1. **asarUnpack設定**: `node_modules/sharp/**/*`をasar外に配置
2. **electron-builder install-app-deps**: 依存関係の自動処理
3. **@electron/rebuild**: 最新の推奨ツールに移行
4. **ビルド前の強制再ビルド**: `npm run rebuild`でSharpを毎回再構築

*最終的な解決方法:*
```json
{
  "scripts": {
    "rebuild": "electron-rebuild -f -w sharp",
    "build-mac": "npm run rebuild && electron-builder --mac"
  },
  "devDependencies": {
    "@electron/rebuild": "^3.7.2"
  },
  "build": {
    "asarUnpack": [
      "node_modules/sharp/**/*",
      "node_modules/@img/**/*"
    ]
  }
}
```

*重要なポイント:*
- ビルド前に必ず`electron-rebuild -f -w sharp`を実行
- asarUnpackでSharp関連モジュールを全て除外
- @electron/rebuildが推奨（electron-rebuildは非推奨）
- JimpからSharpに移行する場合は、Sharpの方が高速だがビルド設定が複雑

**ビルド設定**
- electron-builderを使用してクロスプラットフォームビルドを実行
- ビルド出力は`dist/`フォルダに生成される
- macOSビルド出力：
  - `UniPic-1.0.0-arm64.dmg` - インストーラー（DMG形式）
  - `UniPic-1.0.0-arm64-mac.zip` - ZIP形式の配布パッケージ
  - `mac-arm64/UniPic.app` - macOSアプリケーション本体
- コード署名は開発者証明書が設定されている場合に自動実行される
- macOSのnotarization（公証）は手動で設定する必要がある

## Gemini CLI 連携ガイド

### 目的
ユーザーが **「Geminiと相談しながら進めて」** （または類似表現）と指示した場合、
Claude は **Gemini CLI** を随時呼び出しながら、複数ターンにわたる協業を行う。

### トリガー
- 正規表現: `/Gemini.*相談しながら/`
- 一度トリガーした後は、ユーザーが明示的に終了を指示するまで **協業モード** を維持する。

### 協業ワークフロー (ループ可)
| # | 処理 | 詳細 |
|---|------|------|
| 1 | **PROMPT 準備** | 最新のユーザー要件 + これまでの議論要約を `$PROMPT` に格納 |
| 2 | **Gemini 呼び出し** | ```bash\ngemini <<EOF\n$PROMPT\nEOF\n```<br>必要に応じ `--max_output_tokens` 等を追加 |
| 3 | **出力貼り付け** | `Gemini ➜` セクションに全文、長い場合は要約＋原文リンク |
| 4 | **Claude コメント** | `Claude ➜` セクションで Gemini の提案を分析・統合し、次アクションを提示 |
| 5 | **継続判定** | ユーザー入力 or プラン継続で 1〜4 を繰り返す。<br>「Geminiコラボ終了」「ひとまずOK」等で通常モード復帰 |

### 形式テンプレート
```md
**Gemini ➜**
<Gemini からの応答>
**Claude ➜**
<統合コメント & 次アクション>
```

### エラー処理と例外対応
- Geminiがエラーを返した場合、エラー内容を確認し、別の方法で質問を再構成
- 期待と異なる応答の場合、より具体的な質問で再度確認
- 技術的な問題が発生した場合、ユーザーに報告し判断を仰ぐ

### 状態管理
- 長時間のタスクでは、TodoWriteツールを使用して進捗を管理
- 各ステップの完了状況をGeminiと共有
- 中断・再開時は、これまでの作業内容をサマリーして共有

### ツールの使い分け
- **Claude Code**: ファイル操作、実装、デバッグ、コード生成
- **Gemini CLI**: Web検索、設計提案、技術調査、アーキテクチャ検討

### 最終決定権
- 設計や実装方針で意見が分かれた場合、両方の選択肢をユーザーに提示
- ユーザーの判断を最優先とする

## プロジェクトの現在の状態（2025-07-07更新）

### 開発状況
- **バージョン**: 1.0.0
- **最新コミット**: 71342d4 "アプリの終了条件を修正"
- **ブランチ**: main（origin/mainと同期済み）

### ビルド状況
- **最新ビルド**: 2025-07-04 23:29完了
- **ビルド成果物**:
  - `UniPic-1.0.0-arm64.dmg` (99.9MB) - macOS DMGインストーラー
  - `UniPic-1.0.0-arm64-mac.zip` (96.1MB) - macOS ZIP配布パッケージ
  - `mac-arm64/UniPic.app` - macOSアプリケーション本体

### 未コミット変更
- **変更済み**: CLAUDE.md（Gemini連携セクション追加）
- **未追跡ファイル**: 
  - Gemini.md（Gemini CLI連携用プロジェクト情報）
  - colaboGemini.md（連携設定自動化スクリプト）

### 技術的な状態
- **Sharp依存関係**: 正常に解決済み（v0.33.5）
- **Electron**: v27.0.0で安定動作
- **ビルド環境**: electron-builder + @electron/rebuild構成で動作確認済み

### 連携ツール
- **Gemini CLI**: v0.1.9インストール済み（API制限により一時利用不可）
- **VS Code**: launch.json設定済み（F5キーでデバッグ起動可能）

### 今後の課題
1. メモリ使用量の最適化（大量画像処理時）
2. より高精度な重複検出アルゴリズムの実装
3. クラウドストレージ連携機能の検討
4. 機械学習による画像分類機能の追加検討